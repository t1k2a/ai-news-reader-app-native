name: Weekly AI Summary Thread

on:
  schedule:
    # 毎週日曜 23:00 UTC = 月曜 08:00 JST
    - cron: '0 23 * * 0'
  workflow_dispatch:

jobs:
  weekly-summary:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run weekly summary script
        env:
          X_API_KEY: ${{ secrets.X_API_KEY }}
          X_API_SECRET: ${{ secrets.X_API_SECRET }}
          X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET: ${{ secrets.X_ACCESS_TOKEN_SECRET }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          APP_BASE_URL: ${{ vars.APP_BASE_URL }}
          USE_BRAND_CARD: 'true'
        run: npm run weekly-summary

      - name: Notify on failure
        if: failure()
        run: |
          gh label create "weekly-summary-failure" \
            --color "d73a4a" \
            --description "Weekly summary workflow failure" \
            --force 2>/dev/null || true
          gh issue create \
            --title "Weekly summary failed: $(date -u +%Y-%m-%d)" \
            --body "## Weekly summary failure

          The scheduled weekly summary workflow failed.

          **Details:**
          - Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Please check the workflow logs for details." \
            --label "weekly-summary-failure"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
